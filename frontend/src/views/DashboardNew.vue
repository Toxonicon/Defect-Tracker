<template>
  <!-- –ß–∞—Å—Ç–∏—Ü—ã –≤ —Ñ–æ–Ω–µ -->
  <div class="particles" ref="particlesContainer"></div>
  
  <div class="min-h-screen relative overflow-hidden">
    <!-- –°—É–ø–µ—Ä –∫—Ä–∞—Å–∏–≤—ã–π –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container mx-auto px-4 py-8 relative z-10">
      <!-- –ú–∞–≥–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="text-center mb-12 floating">
        <h1 class="text-6xl font-black mb-6 neon-glow holographic">
          Defect Tracker Pro
        </h1>
        <p class="text-xl text-white-80 mb-8 max-w-2xl mx-auto">
          –†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ —Å –±–µ–∑—É–º–Ω–æ –∫—Ä–∞—Å–∏–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        </p>
        
        <!-- 3D Flip –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
        <div class="flip-card max-w-md mx-auto mb-8">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <div class="animated-icon">üìä</div>
              <h3 class="text-2xl font-bold text-white mt-4">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
              <p class="text-white-70 mt-2">–ù–∞–≤–µ–¥–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</p>
            </div>
            <div class="flip-card-back">
              <div class="text-white">
                <h3 class="text-xl font-bold mb-4">–ê–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <div class="text-2xl font-bold">{{ stats.total }}</div>
                    <div>–í—Å–µ–≥–æ –¥–µ—Ñ–µ–∫—Ç–æ–≤</div>
                  </div>
                  <div>
                    <div class="text-2xl font-bold">{{ stats.active }}</div>
                    <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                  </div>
                  <div>
                    <div class="text-2xl font-bold">{{ stats.resolved }}</div>
                    <div>–†–µ—à–µ–Ω–Ω—ã—Ö</div>
                  </div>
                  <div>
                    <div class="text-2xl font-bold">{{ stats.critical }}</div>
                    <div>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ -->
      <div class="grid md-grid-cols-3 gap-8 mb-12">
        <div class="card pulse hover-scale-105 transition-all duration-500">
          <div class="card-body">
            <div class="animated-icon mb-4">üöÄ</div>
            <h3 class="text-2xl font-bold text-white mb-4">–°–æ–∑–¥–∞—Ç—å –¥–µ—Ñ–µ–∫—Ç</h3>
            <p class="text-white-70 mb-6">
              –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –¥–µ—Ñ–µ–∫—Ç —Å —Å—É–ø–µ—Ä-–±—ã—Å—Ç—Ä–æ–π —Ñ–æ—Ä–º–æ–π
            </p>
            <router-link to="/defects/create" class="btn btn-primary">
              ‚ú® –°–æ–∑–¥–∞—Ç—å
            </router-link>
          </div>
        </div>

        <div class="card pulse hover-scale-105 transition-all duration-500" style="animation-delay: 0.2s;">
          <div class="card-body">
            <div class="animated-icon mb-4">üìã</div>
            <h3 class="text-2xl font-bold text-white mb-4">–í—Å–µ –¥–µ—Ñ–µ–∫—Ç—ã</h3>
            <p class="text-white-70 mb-6">
              –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Å–µ–º–∏ –¥–µ—Ñ–µ–∫—Ç–∞–º–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
            </p>
            <router-link to="/defects" class="btn btn-secondary">
              üîç –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
            </router-link>
          </div>
        </div>

        <div class="card pulse hover-scale-105 transition-all duration-500" style="animation-delay: 0.4s;">
          <div class="card-body">
            <div class="animated-icon mb-4">üìä</div>
            <h3 class="text-2xl font-bold text-white mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
            <p class="text-white-70 mb-6">
              –ì–ª—É–±–æ–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∫—Ä–∞—Å–∏–≤—ã–µ –æ—Ç—á–µ—Ç—ã
            </p>
            <button class="btn btn-success" @click="showAnalytics = true">
              üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            </button>
          </div>
        </div>
      </div>

      <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç—ã —Å –Ω–µ–æ–Ω–æ–≤—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ -->
      <div class="card mb-8 container-3d">
        <div class="card-header">
          <h2 class="text-3xl font-bold text-white holographic">
            üî• –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç—ã
          </h2>
        </div>
        <div class="card-body">
          <div v-if="loading" class="text-center py-12">
            <div class="loading-shimmer w-full h-64 rounded-lg"></div>
            <p class="text-white-70 mt-4">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–≥–∏—é...</p>
          </div>
          
          <div v-else-if="defects.length === 0" class="text-center py-12">
            <div class="animated-icon mb-4">üé≠</div>
            <p class="text-white-70 text-xl">–î–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç - –∏–¥–µ–∞–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª–æ!</p>
          </div>
          
          <div v-else class="grid gap-6">
            <div 
              v-for="(defect, index) in defects.slice(0, 5)" 
              :key="defect.id"
              class="defect-card bg-white-10 backdrop-blur-lg rounded-2xl p-6 border border-white-20 hover-bg-white-20 transition-all duration-500 floating"
              :style="{ animationDelay: index * 0.1 + 's' }"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-4 mb-3">
                    <span 
                      class="badge"
                      :class="getPriorityClass(defect.priority)"
                    >
                      {{ getPriorityIcon(defect.priority) }} {{ defect.priority }}
                    </span>
                    <span 
                      class="badge"
                      :class="getStatusClass(defect.status)"
                    >
                      {{ getStatusIcon(defect.status) }} {{ defect.status }}
                    </span>
                  </div>
                  
                  <h3 class="text-xl font-bold text-white mb-2">{{ defect.title }}</h3>
                  <p class="text-white-70 mb-3">{{ defect.description }}</p>
                  
                  <div class="flex items-center gap-4 text-sm text-white-60">
                    <span>üèóÔ∏è {{ defect.location }}</span>
                    <span>üë§ {{ defect.reported_by }}</span>
                    <span>üìÖ {{ formatDate(defect.created_at) }}</span>
                  </div>
                </div>
                
                <div class="ml-4">
                  <button 
                    class="btn btn-primary btn-sm"
                    @click="openDefectDetails(defect)"
                  >
                    üëÅÔ∏è –î–µ—Ç–∞–ª–∏
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div v-if="defects.length > 5" class="text-center mt-8">
            <router-link to="/defects" class="btn btn-warning">
              üöÄ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–µ—Ñ–µ–∫—Ç—ã
            </router-link>
          </div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º -->
      <div class="grid md-grid-cols-4 gap-6 mb-8">
        <div 
          v-for="(priority, index) in priorityStats" 
          :key="priority.name"
          class="card text-center floating"
          :style="{ animationDelay: index * 0.15 + 's' }"
        >
          <div class="card-body">
            <div class="text-4xl mb-3">{{ priority.icon }}</div>
            <div class="text-3xl font-bold text-white mb-2 neon-glow">{{ priority.count }}</div>
            <div class="text-white-70">{{ priority.name }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
    <div 
      v-if="showAnalytics" 
      class="fixed inset-0 bg-black-50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
      @click="showAnalytics = false"
    >
      <div class="card max-w-4xl w-full max-h-90vh overflow-y-auto" @click.stop>
        <div class="card-header">
          <h2 class="text-3xl font-bold text-white holographic">üìä –°—É–ø–µ—Ä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
          <button 
            @click="showAnalytics = false"
            class="absolute top-4 right-4 text-white-70 hover-text-white text-2xl"
          >
            ‚úï
          </button>
        </div>
        <div class="card-body">
          <div class="grid md-grid-cols-2 gap-6 mb-6">
            <div class="bg-white-10 rounded-xl p-4">
              <h3 class="text-xl font-bold text-white mb-3">üéØ –ü–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
              <div class="space-y-2">
                <div v-for="status in statusAnalytics" :key="status.name" class="flex justify-between">
                  <span class="text-white-70">{{ status.icon }} {{ status.name }}</span>
                  <span class="text-white font-bold">{{ status.count }}</span>
                </div>
              </div>
            </div>
            
            <div class="bg-white-10 rounded-xl p-4">
              <h3 class="text-xl font-bold text-white mb-3">‚ö° –ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º</h3>
              <div class="space-y-2">
                <div v-for="priority in priorityStats" :key="priority.name" class="flex justify-between">
                  <span class="text-white-70">{{ priority.icon }} {{ priority.name }}</span>
                  <span class="text-white font-bold">{{ priority.count }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="bg-white-10 rounded-xl p-4">
            <h3 class="text-xl font-bold text-white mb-3">üèÜ –¢–æ–ø –ª–æ–∫–∞—Ü–∏–π</h3>
            <div class="grid md-grid-cols-3 gap-4">
              <div v-for="location in topLocations" :key="location.name" class="text-center">
                <div class="text-2xl font-bold text-white neon-glow">{{ location.count }}</div>
                <div class="text-white-70">{{ location.name }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '../stores/auth'

const router = useRouter()
const authStore = useAuthStore()
const loading = ref(true)
const defects = ref([])
const showAnalytics = ref(false)
const particlesContainer = ref(null)

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const stats = computed(() => {
  const total = defects.value.length
  const active = defects.value.filter(d => d.status !== 'Resolved').length
  const resolved = defects.value.filter(d => d.status === 'Resolved').length
  const critical = defects.value.filter(d => d.priority === 'Critical').length
  
  return { total, active, resolved, critical }
})

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
const priorityStats = computed(() => {
  const priorities = ['Low', 'Medium', 'High', 'Critical']
  const icons = ['üü¢', 'üü°', 'üü†', 'üî¥']
  
  return priorities.map((priority, index) => ({
    name: priority,
    icon: icons[index],
    count: defects.value.filter(d => d.priority === priority).length
  }))
})

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
const statusAnalytics = computed(() => {
  const statuses = ['Open', 'In Progress', 'Testing', 'Resolved']
  const icons = ['üÜï', '‚ö°', 'üî¨', '‚úÖ']
  
  return statuses.map((status, index) => ({
    name: status,
    icon: icons[index],
    count: defects.value.filter(d => d.status === status).length
  }))
})

// –¢–æ–ø –ª–æ–∫–∞—Ü–∏–π
const topLocations = computed(() => {
  const locationCounts = {}
  defects.value.forEach(defect => {
    locationCounts[defect.location] = (locationCounts[defect.location] || 0) + 1
  })
  
  return Object.entries(locationCounts)
    .map(([name, count]) => ({ name, count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 3)
})

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤
const loadDefects = async () => {
  try {
    loading.value = true
    
    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
    const response = await fetch('http://localhost:3000/api/defects')
    if (response.ok) {
      defects.value = await response.json()
    } else {
      throw new Error('Server not available')
    }
  } catch (error) {
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ:', error.message)
    
    // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    defects.value = [
      {
        id: 1,
        title: '–¢—Ä–µ—â–∏–Ω–∞ –≤ –Ω–µ—Å—É—â–µ–π —Å—Ç–µ–Ω–µ',
        description: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —Ç—Ä–µ—â–∏–Ω–∞ –¥–ª–∏–Ω–æ–π 2 –º–µ—Ç—Ä–∞ –≤ –Ω–µ—Å—É—â–µ–π —Å—Ç–µ–Ω–µ –∑–¥–∞–Ω–∏—è',
        priority: 'Critical',
        status: 'Open',
        location: '–ó–¥–∞–Ω–∏–µ A, 3 —ç—Ç–∞–∂',
        reported_by: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
        created_at: new Date().toISOString()
      },
      {
        id: 2,
        title: '–ü—Ä–æ—Ç–µ—á–∫–∞ –∫—Ä—ã—à–∏',
        description: '–ü—Ä–æ—Ç–µ—á–∫–∞ –≤–æ–¥—ã —á–µ—Ä–µ–∑ –∫—Ä–æ–≤–ª—é –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞',
        priority: 'High',
        status: 'In Progress',
        location: '–°–∫–ª–∞–¥ B',
        reported_by: '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
        created_at: new Date(Date.now() - 86400000).toISOString()
      },
      {
        id: 3,
        title: '–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å –ø–æ–ª–∞',
        description: '–ù–µ—Ä–æ–≤–Ω–æ—Å—Ç—å –ø–æ–ª–∞ –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ, —Å–æ–∑–¥–∞—é—â–∞—è –æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è',
        priority: 'Medium',
        status: 'Testing',
        location: '–ö–æ—Ä–∏–¥–æ—Ä 1-–≥–æ —ç—Ç–∞–∂–∞',
        reported_by: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–æ–∑–ª–æ–≤',
        created_at: new Date(Date.now() - 172800000).toISOString()
      },
      {
        id: 4,
        title: '–û—Ç—Å–ª–æ–µ–Ω–∏–µ —à—Ç—É–∫–∞—Ç—É—Ä–∫–∏',
        description: '–û—Ç—Å–ª–æ–µ–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —à—Ç—É–∫–∞—Ç—É—Ä–∫–∏ –Ω–∞ —Ñ–∞—Å–∞–¥–µ –∑–¥–∞–Ω–∏—è',
        priority: 'Low',
        status: 'Resolved',
        location: '–§–∞—Å–∞–¥ –∑–¥–∞–Ω–∏—è C',
        reported_by: '–ï–ª–µ–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–∞',
        created_at: new Date(Date.now() - 259200000).toISOString()
      },
      {
        id: 5,
        title: '–ü—Ä–æ–±–ª–µ–º—ã —Å —ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∫–æ–π',
        description: '–ü–µ—Ä–µ–±–æ–∏ –≤ –ø–æ–¥–∞—á–µ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ –≤ –æ—Ñ–∏—Å–Ω—ã—Ö –ø–æ–º–µ—â–µ–Ω–∏—è—Ö',
        priority: 'High',
        status: 'Open',
        location: '–û—Ñ–∏—Å 205',
        reported_by: '–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤',
        created_at: new Date(Date.now() - 345600000).toISOString()
      }
    ]
  } finally {
    loading.value = false
  }
}

// –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Å—Ç–∏–ª–µ–π
const getPriorityClass = (priority) => {
  const classes = {
    'Low': 'badge-success',
    'Medium': 'badge-warning', 
    'High': 'badge-danger',
    'Critical': 'badge-danger'
  }
  return classes[priority] || 'badge-primary'
}

const getStatusClass = (status) => {
  const classes = {
    'Open': 'badge-danger',
    'In Progress': 'badge-warning',
    'Testing': 'badge-primary',
    'Resolved': 'badge-success'
  }
  return classes[status] || 'badge-primary'
}

const getPriorityIcon = (priority) => {
  const icons = {
    'Low': 'üü¢',
    'Medium': 'üü°',
    'High': 'üü†', 
    'Critical': 'üî¥'
  }
  return icons[priority] || '‚ö™'
}

const getStatusIcon = (status) => {
  const icons = {
    'Open': 'üÜï',
    'In Progress': '‚ö°',
    'Testing': 'üî¨',
    'Resolved': '‚úÖ'
  }
  return icons[status] || '‚ùì'
}

const formatDate = (dateString) => {
  return new Date(dateString).toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  })
}

const openDefectDetails = (defect) => {
  router.push(`/defects/${defect.id}`)
}

// –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
const createParticles = () => {
  if (!particlesContainer.value) return
  
  const container = particlesContainer.value
  
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement('div')
    particle.className = 'particle'
    particle.style.left = Math.random() * 100 + '%'
    particle.style.width = Math.random() * 4 + 2 + 'px'
    particle.style.height = particle.style.width
    particle.style.animationDelay = Math.random() * 6 + 's'
    particle.style.animationDuration = (Math.random() * 3 + 3) + 's'
    
    container.appendChild(particle)
  }
}

onMounted(() => {
  loadDefects()
  createParticles()
})
</script>

<style scoped>
.defect-card {
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.defect-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

.text-white-80 {
  color: rgba(255, 255, 255, 0.8);
}

.border-white-20 {
  border-color: rgba(255, 255, 255, 0.2);
}

.hover-bg-white-20:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

.hover-text-white:hover {
  color: white;
}

.hover-scale-105:hover {
  transform: scale(1.05);
}

.md-grid-cols-2 {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.md-grid-cols-3 {
  grid-template-columns: repeat(3, minmax(0, 1fr));
}

.md-grid-cols-4 {
  grid-template-columns: repeat(4, minmax(0, 1fr));
}

@media (min-width: 768px) {
  .md-grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  .md-grid-cols-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  
  .md-grid-cols-4 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}
</style>